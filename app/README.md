# Система резервного копирования и мониторинга базы данных

В проекте реализована система автоматического резервного копирования и мониторинга состояния базы данных, которая помогает предотвратить потерю данных и обеспечивает быстрое восстановление в случае сбоев.

## Компоненты системы

### 1. Мониторинг здоровья базы данных (`check_db.py`)

Сервис `db_health_check` регулярно проверяет доступность базы данных и автоматически восстанавливает её в случае проблем:

- Проверяет подключение к базе данных каждые 5 минут
- Автоматически создаёт базу данных, если она отсутствует
- Инициализирует схему базы данных
- Ведёт подробные логи о состоянии базы данных

### 2. Система резервного копирования (`backup_db.py`)

Сервис `db_backup` создаёт регулярные резервные копии базы данных:

- Создаёт ежедневные резервные копии базы данных
- Хранит последние 7 копий (настраивается через `MAX_BACKUPS`)
- Автоматически удаляет устаревшие резервные копии
- Предоставляет инструменты для ручного создания резервных копий и восстановления

## Использование системы резервного копирования

### Ручное создание резервной копии

```bash
docker exec cli-flow-db_backup-1 python backup_db.py backup
```

### Восстановление из последней резервной копии

```bash
docker exec cli-flow-db_backup-1 python backup_db.py restore
```

### Восстановление из конкретной резервной копии

```bash
# Сначала посмотрим список доступных резервных копий
docker exec cli-flow-db_backup-1 ls -la /app/backups

# Восстановление из конкретного файла
docker exec cli-flow-db_backup-1 python backup_db.py restore /app/backups/rhcsa_db_20250521_120000.sql
```

## Настройка системы резервного копирования

Параметры системы резервного копирования можно настроить через переменные окружения в `docker-compose.yml`:

- `BACKUP_INTERVAL`: интервал между созданием резервных копий в секундах (по умолчанию 86400 - 24 часа)
- `MAX_BACKUPS`: максимальное количество хранимых резервных копий (по умолчанию 7)
- `BACKUP_DIR`: директория для хранения резервных копий (по умолчанию `/app/backups`)

## Логи системы

Логи системы резервного копирования и мониторинга доступны в директории `logs`:

```bash
# Просмотр логов мониторинга базы данных
docker exec cli-flow-web-1 cat /app/logs/db_health_check.log

# Просмотр логов системы резервного копирования
docker exec cli-flow-web-1 cat /app/logs/db_backup.log
```

## Рекомендации по безопасности

1. Регулярно копируйте резервные копии на внешнее хранилище:
   ```bash
   # Пример копирования всех резервных копий на внешний сервер
   docker cp cli-flow-db_backup-1:/app/backups/ /path/to/external/storage/
   ```

2. Настройте ограничение доступа к серверу через брандмауэр, разрешая подключения только с доверенных IP-адресов.

3. Используйте сложные пароли для базы данных и регулярно их меняйте.

4. Настройте HTTPS для защиты передаваемых данных. 